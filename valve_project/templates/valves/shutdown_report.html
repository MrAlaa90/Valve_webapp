{% extends 'base.html' %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5.min.css" />
<style>
    /* Force Select2 to be 100% width and override its dynamic resizing */
    .select2-container {
        width: 100% !important;
    }

    /* Ensure Select2 search field also takes appropriate width */
    .select2-container .select2-search--inline .select2-search__field {
        width: 100% !important; /* Ensure it takes full available width */
        min-width: 150px; /* Prevent it from becoming too small */
    }

    /* Custom styling for selected tags */
    .selected-valve-tag {
        display: inline-flex;
        align-items: center;
        margin-right: 5px;
        margin-bottom: 5px;
        padding: .35em .65em;
        font-size: .75em;
        font-weight: 700;
        line-height: 1;
        color: #fff;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: .25rem;
    }
    .selected-valve-tag .remove-tag {
        margin-left: 5px;
        cursor: pointer;
        font-weight: bold;
        color: rgba(255, 255, 255, 0.7);
    }
    .selected-valve-tag .remove-tag:hover {
        color: #fff;
    }

    /* Hide Select2's default internal selection tags */
    .select2-container .select2-selection--multiple .select2-selection__choice {
        display: none !important;
    }

    /* Make Select2 dropdown menu scrollable */
    .select2-container--open .select2-dropdown {
        max-height: 200px; /* Adjust as needed */
        overflow-y: auto;
    }

    /* Select2 Dropdown Dark Mode Adjustments */
    .select2-container--open .select2-dropdown {
        background-color: #343a40; /* Dark background */
        border-color: #495057;     /* Darker border */
    }

    .select2-results__option {
        color: #f8f9fa; /* Light text color */
    }

    .select2-results__option--highlighted {
        background-color: #0d6efd !important; /* Bootstrap primary blue for highlight */
        color: #fff !important;
    }

    .select2-search__field {
        background-color: #495057 !important; /* Darker search input background */
        color: #f8f9fa !important; /* Light text for search input */
        border-color: #495057 !important;
    }
</style>
{% endblock %}

{% block title %}Shutdown Reports{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Shutdown Reports</h2>

    <!-- Shutdown Report Form -->
    <div class="card mb-4 no-print">
        <div class="card-header">
            Create New Shutdown Report
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                {{ form.media }}
                <div class="form-group">
                    <label for="id_factory">Factory</label>
                    {{ form.factory }}
                </div>
                <div class="form-group">
                    <label for="id_start_date">Start Date</label>
                    {{ form.start_date }}
                </div>
                <div class="form-group">
                    <label for="id_end_date">End Date</label>
                    {{ form.end_date }}
                </div>
                <div class="form-group">
                    <label for="id_valves">Affected Valves</label>
                    {{ form.valves }}
                    <div id="selected-valves-container" class="mt-2"></div>
                </div>
                <button type="submit" class="btn btn-primary mt-3">Create Report</button>
            </form>
        </div>
    </div>

    <!-- Filter Form -->
    <div class="card mb-4 no-print">
        <div class="card-header">
            Filter Reports
        </div>
        <div class="card-body">
            <form method="get">
                <div class="row">
                    <div class="col-md-3">
                        <select name="factory" class="form-control">
                            <option value="">All Factories</option>
                            {% for factory in factories %}
                                <option value="{{ factory.id }}" {% if factory.id|stringformat:"s" == selected_factory_id %}selected{% endif %}>{{ factory.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="date" name="start_date" class="form-control" value="{{ selected_start_date|default:'' }}">
                    </div>
                    <div class="col-md-3">
                        <input type="date" name="end_date" class="form-control" value="{{ selected_end_date|default:'' }}">
                    </div>
                    <div class="col-md-2">
                        <label for="print-date">Print Date</label>
                        <input type="date" id="print-date" class="form-control">
                    </div>
                    <div class="col-md-1">
                        <button type="submit" class="btn btn-secondary">Filter</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Shutdown Reports Table -->
    <div class="card">
        <div class="card-header">
            Shutdowns List
        </div>
        <div class="card-body">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Factory</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Total Valves</th>
                        <th>Affected Valves</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for shutdown in shutdowns %}
                    <tr>
                        <td>{{ shutdown.factory }}</td>
                        <td>{{ shutdown.start_date }}</td>
                        <td>{{ shutdown.end_date }}</td>
                        <td>{{ shutdown.valves.count }}</td>
                        <td>
                            <ul>
                                {% for valve in shutdown.valves.all %}
                                    <li>{{ valve.tag_number }}</li>
                                {% endfor %}
                            </ul>
                        </td>
                        <td>
                            <a href="{% url 'valves:shutdown-report-print' pk=shutdown.pk %}" target="_blank" class="btn btn-info btn-sm">Print</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const factorySelect = document.getElementById('id_factory');
        const valvesSelect = $('#id_valves');
        const selectedValvesContainer = document.getElementById('selected-valves-container');

        // Initialize Select2 with AJAX
        valvesSelect.select2({
            theme: 'bootstrap-5',
            placeholder: 'Select a factory first',
            width: '100%', // Set width to 100%
            ajax: {
                url: "{% url 'valves:get-valves-by-factory' %}",
                dataType: 'json',
                delay: 250,
                data: function(params) {
                    return {
                        q: params.term, // search term
                        factory: factorySelect.value
                    };
                },
                processResults: function(data) {
                    return {
                        results: data.map(item => ({
                            id: item.valve_id,
                            text: item.tag_number
                        }))
                    };
                },
                cache: true
            },
            templateSelection: function () {
                // Hide selection in the input, we use the container below
                return '';
            }
        });

        // Initially disable the valve select
        valvesSelect.prop('disabled', true);

        // Event listener for factory selection
        factorySelect.addEventListener('change', function() {
            const factoryId = this.value;
            // Clear current selection and options
            valvesSelect.val(null).trigger('change');
            if (factoryId) {
                valvesSelect.prop('disabled', false);
                valvesSelect.data('select2').$container.find('.select2-selection__placeholder').text('Search for valves...');
                // Manually trigger an AJAX request on first open if needed, or rely on user typing/opening
            } else {
                valvesSelect.prop('disabled', true);
                valvesSelect.data('select2').$container.find('.select2-selection__placeholder').text('Select a factory first');
            }
        });

        // Function to render selected tags
        function renderSelectedTags() {
            selectedValvesContainer.innerHTML = '';
            const selectedOptions = valvesSelect.select2('data');

            selectedOptions.forEach(function(option) {
                if (!option.id) return; // Skip placeholder
                const tag = document.createElement('span');
                tag.className = 'selected-valve-tag bg-primary';
                tag.setAttribute('data-valve-id', option.id);
                tag.innerHTML = `${option.text} <span class="remove-tag">&times;</span>`;

                tag.querySelector('.remove-tag').addEventListener('click', function() {
                    const currentSelections = valvesSelect.val();
                    const newSelections = currentSelections.filter(id => id !== option.id);
                    valvesSelect.val(newSelections).trigger('change');
                });
                selectedValvesContainer.appendChild(tag);
            });
        }

        // Update tags when selection changes
        valvesSelect.on('change', renderSelectedTags);
        
    });
</script>
{% endblock %}
